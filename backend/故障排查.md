# 故障排查指南

## 🐛 常见问题和解决方案

### 问题1：点击单词显示一长串字符

**症状**：
```
未找到单词的释义
尝试查询的单词：yeahsuresaidjackarealmonsterinfrogcreekpennsylvania
```

**原因**：前端单词提取逻辑有bug，把整个句子都当成一个单词了

**解决方案**：已修复 ✅
- 使用了更智能的单词提取算法
- 支持点击位置的精确单词识别
- 支持文本选中查询

**测试方法**：
1. 重启前端服务（`npm run dev`）
2. 点击任意单词，应该只查询该单词

---

### 问题2：查询速度很慢

**症状**：点击单词后等待很久才显示结果

**原因和解决方案**：

#### 2.1 首次查询慢（正常）
- 有道API响应时间：200-500ms
- 缓存后的查询：<10ms

#### 2.2 超时设置过长
- **已优化**：从10秒改为5秒 ✅
- 失败时会更快返回错误

#### 2.3 网络问题
**检查方法**：
```bash
# 测试有道API连通性
curl -w "\nTime: %{time_total}s\n" "https://openapi.youdao.com/api"
```

**解决方案**：
- 检查网络连接
- 确认防火墙没有屏蔽有道API

#### 2.4 有道API错误
**查看后端日志**：
```bash
cd backend
python3 -m uvicorn main:app --reload --port 8000
```

常见错误码：
| 错误码 | 说明 | 解决方法 |
|--------|------|---------|
| 108 | 应用ID无效 | 检查YOUDAO_APP_KEY |
| 202 | 签名检验失败 | 检查YOUDAO_APP_SECRET |
| 401 | 账户已欠费 | 充值或升级套餐 |
| 411 | 访问频率受限 | 等待一段时间或升级套餐 |

---

### 问题3：配置了有道API但还是报错

**症状**：
```
有道词典API未配置，请在.env文件中设置...
```

**排查步骤**：

#### 3.1 检查.env文件是否存在
```bash
cd backend
ls -la .env
```

如果不存在：
```bash
cp .env.example .env
# 然后编辑.env文件，填入你的密钥
```

#### 3.2 检查环境变量是否加载
```bash
python3 -c "
from dotenv import load_dotenv
import os
load_dotenv()
print('APP_KEY:', os.getenv('YOUDAO_APP_KEY'))
print('APP_SECRET:', os.getenv('YOUDAO_APP_SECRET'))
"
```

应该显示你的密钥（部分内容）。

#### 3.3 检查配置格式
`.env` 文件格式：
```bash
# ❌ 错误（有多余空格）
YOUDAO_APP_KEY = your_key_here

# ✅ 正确
YOUDAO_APP_KEY=your_key_here
YOUDAO_APP_SECRET=your_secret_here
```

#### 3.4 重启服务器
**重要**：修改.env文件后必须重启！
```bash
# 按 Ctrl+C 停止服务器
# 然后重新启动
python3 -m uvicorn main:app --reload --port 8000
```

---

### 问题4：词形还原不工作

**症状**：点击"running"、"went"等词形变化查不到

**可能原因**：NLTK数据未下载

**解决方案**：
```bash
python3 -c "
import nltk
nltk.download('wordnet')
nltk.download('omw-1.4')
nltk.download('averaged_perceptron_tagger')
"
```

**验证**：
```bash
python3 -c "
from app.api.dictionary import lemmatize_word
print('running ->', lemmatize_word('running'))
print('went ->', lemmatize_word('went'))
print('children ->', lemmatize_word('children'))
"
```

应该显示：
```
running -> run
went -> go
children -> child
```

---

### 问题5：查询成功但没有中文释义

**症状**：返回结果但只有英文或没有释义

**原因**：有道API配置问题或单词不存在

**检查后端日志**：
```bash
# 应该看到类似的日志
✅ 查询成功: hello (234ms)
```

如果看到：
```bash
❌ 有道API错误码: 102
   不支持的语言类型
```

**解决方案**：
1. 检查有道应用是否选择了"自然语言翻译"服务
2. 确认from='en', to='zh-CHS'配置正确

---

## 📊 性能监控

### 查看查询日志
后端会输出详细的性能日志：
```
✅ 缓存命中: hello (2ms)         # 缓存查询，极快
✅ 查询成功: world (345ms)       # API查询，正常速度
🔄 词形还原: running → run       # 词形还原过程
✅ 查询词根成功: run (456ms)    # 词根查询成功
❌ 未找到: abcdefg (567ms)       # 查询失败
```

### 性能基准
| 场景 | 预期时间 | 说明 |
|------|---------|------|
| 缓存命中 | <10ms | 极快 |
| API查询（首次） | 200-500ms | 正常 |
| 词形还原+查询 | 300-700ms | 正常 |
| 查询失败 | <500ms | 快速返回 |

如果超过1秒，检查：
1. 网络连接
2. 有道API状态
3. 服务器负载

---

## 🔧 调试技巧

### 1. 查看完整的API请求
在`dictionary.py`的`query_youdao_dict`函数中添加：
```python
print(f"请求参数: {params}")
print(f"请求URL: {YOUDAO_DICT_API}")
```

### 2. 测试单个单词
```bash
curl "http://localhost:8000/api/dictionary/hello"
```

### 3. 检查缓存状态
在`dictionary.py`添加：
```python
print(f"缓存大小: {len(_dictionary_cache)} 个词")
```

### 4. 清空缓存
重启服务器会自动清空缓存。

---

## 📞 获取帮助

如果以上方法都无法解决问题：

1. **查看完整日志**：
   ```bash
   cd backend
   python3 -m uvicorn main:app --reload --port 8000 > debug.log 2>&1
   ```

2. **检查有道API配额**：
   访问 https://ai.youdao.com/console
   查看调用统计和剩余额度

3. **测试有道API**：
   使用有道提供的在线测试工具
   确认密钥有效

4. **联系支持**：
   提供以上日志信息

---

## ✅ 优化建议

1. **缓存预热**：
   启动后先查询常用词，填充缓存

2. **监控API调用**：
   定期检查有道控制台，避免超出额度

3. **升级套餐**：
   如果调用量大，考虑升级付费套餐

4. **备用方案**：
   保存离线词典数据作为备份
