# 词典API配置指南

本项目支持多个词典API源，提供灵活的查词体验。

## 支持的词典源

### 1. 有道词典API（推荐 ⭐）
**优势**：
- ✅ 提供中英双语释义
- ✅ 音标准确
- ✅ 响应速度快
- ✅ 免费额度充足

**配置步骤**：

1. **注册账号**
   - 访问 [有道智云AI开放平台](https://ai.youdao.com/)
   - 注册并登录账号

2. **创建应用**
   - 进入控制台
   - 点击「创建应用」
   - 选择「自然语言翻译」服务
   - 填写应用名称（如：英语阅读助手）

3. **获取密钥**
   - 创建成功后，记录以下信息：
     - 应用ID（APP_KEY）
     - 应用密钥（APP_SECRET）

4. **配置环境变量**
   ```bash
   cd backend
   cp .env.example .env
   ```

   编辑 `.env` 文件，填入你的密钥：
   ```bash
   YOUDAO_APP_KEY=你的应用ID
   YOUDAO_APP_SECRET=你的应用密钥
   ```

5. **重启后端服务**
   ```bash
   python3 -m uvicorn main:app --reload --port 8000
   ```

### 2. Free Dictionary API（默认）
**优势**：
- ✅ 完全免费
- ✅ 无需注册
- ✅ 自动启用

**劣势**：
- ❌ 仅提供英文释义
- ❌ 部分单词可能查不到

**说明**：
- 如果未配置有道词典API，系统将自动使用此词典
- 无需任何配置，开箱即用

### 3. Words API（可选）
**优势**：
- ✅ 词汇量大
- ✅ 提供丰富的例句

**劣势**：
- ❌ 需要付费订阅（通过RapidAPI）
- ❌ 仅提供英文释义

**配置步骤**：

1. 访问 [RapidAPI - Words API](https://rapidapi.com/dpventures/api/wordsapi)
2. 注册RapidAPI账号并订阅（有免费额度）
3. 获取API Key
4. 在 `.env` 文件中配置：
   ```bash
   WORDS_API_KEY=你的RapidAPI密钥
   ```

## 查询优先级

系统会按以下顺序查询词典（优先使用配置的词典）：

1. **缓存检查**（24小时有效）
2. **有道词典**（如已配置）→ 提供中文释义
3. **Free Dictionary API**（默认启用）→ 英文释义
4. **Words API**（如已配置）→ 补充查询
5. **词形还原后重复上述流程**

## 常见问题

### 1. 为什么推荐配置有道词典？
中国用户更习惯中英双语释义，有道词典提供的翻译质量高且响应速度快。

### 2. 免费额度够用吗？
有道词典API提供免费额度，对于个人学习使用完全足够。如果超出免费额度，可以考虑付费订阅。

### 3. 如何查看API调用次数？
登录有道智云控制台，可以查看应用的调用统计。

### 4. 缓存如何清理？
缓存会自动过期（24小时），重启服务会清空缓存。如需手动清理，可以在代码中调用 `clear_expired_cache()` 函数。

### 5. 支持离线词典吗？
当前版本不支持离线词典。未来可能会添加ECDICT等离线词典支持。

## 性能优化

系统已实现以下优化：

1. **请求缓存**：查询结果缓存24小时，减少API调用
2. **词形还原缓存**：使用 `@lru_cache` 缓存词形还原结果
3. **异步请求**：使用 `httpx.AsyncClient` 提高并发性能
4. **智能降级**：当主词典不可用时，自动使用备用词典

## 故障排查

### 有道词典返回错误
```python
# 检查环境变量是否正确
import os
print(os.getenv("YOUDAO_APP_KEY"))
print(os.getenv("YOUDAO_APP_SECRET"))
```

### 网络超时
增加超时时间（默认30秒）：
```python
# 在 dictionary.py 中修改
async with httpx.AsyncClient(timeout=60.0) as client:
    ...
```

### 查不到单词
1. 检查词典API配置是否正确
2. 尝试词形还原（系统会自动处理）
3. 查看后端日志，确认错误信息

## 更新日志

### v1.1（当前版本）
- ✅ 添加有道词典API支持
- ✅ 添加请求缓存机制
- ✅ 改进错误处理
- ✅ 优化查询顺序

### v1.0（初始版本）
- ✅ Free Dictionary API
- ✅ Words API备用
- ✅ 词形还原功能
