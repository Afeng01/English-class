{
  "generatedAt": "2025-11-30 12:48 (UTC+8) Codex",
  "frontendTranslation": {
    "wordClickTrigger": {
      "location": "frontend/src/components/ReaderPage.tsx:265-325",
      "details": "getWordAtPoint 利用 document.caretRangeFromPoint / caretPositionFromPoint 在点击处定位文本节点并向前/向后扫描 a-zA-Z'-。handleContentClick 优先处理 window.getSelection()（限制 200 字符并允许空格、常见标点），否则回退到单词提取并把结果写入 selectedWord；contentRef DOM 在章节渲染完成后统一绑定 click 事件。"
    },
    "lookupInvocation": {
      "location": "frontend/src/components/ReaderPage.tsx:326-354",
      "details": "selectedWord 变化触发 useEffect，lookupWord 置 lookupLoading 为 true，调用 dictionaryAPI.lookup(selectedWord) 并在成功后写入 wordDefinition。调用是单次 await Promise，没有并发查询与取消逻辑，因此每次点击都会顺序发起一次请求。"
    },
    "resultDisplay": [
      {
        "component": "fixedSidebar",
        "location": "frontend/src/components/ReaderPage.tsx:912-1109",
        "details": "dictionaryMode === 'fixed' 时渲染右侧词典栏，提供 GripVertical 拖拽手柄调整 sidebarWidth，同时在 sticky 容器里展示词条、音标、释义列表以及加入生词本按钮；释义会根据 showEnglish/showChinese（localStorage 存储）过滤。"
      },
      {
        "component": "floatingWindow",
        "location": "frontend/src/components/ReaderPage.tsx:1115-1320",
        "details": "dictionaryMode === 'floating' 渲染带拖拽/缩放逻辑的悬浮窗（handleWindowDragStart、handleResizeStart），复用与固定模式一致的释义渲染与收藏按钮，顶部提供固定/隐藏控制。"
      }
    ],
    "apiClient": {
      "location": "frontend/src/services/api.ts:1-110",
      "details": "axios.create 统一设置 baseURL（VITE_API_BASE_URL 或 '/api'）与 10000ms 超时；dictionaryAPI.lookup(word) 直接发起 GET /dictionary/{word} 并按 DictionaryResult 类型返回英/中文混合结果。"
    }
  },
  "backendTranslationAPI": {
    "chineseYoudao": {
      "location": "backend/app/api/dictionary.py:243-344",
      "details": "query_youdao_translate 在检测 YOUDAO_APP_KEY/SECRET 后，使用 truncate(q) + salt + curtime 生成 sha256 签名并以 GET 请求 https://openapi.youdao.com/api（from=en,to=zh-CHS, timeout=5s）。优先解析 basic.explains 列表，把每条解释映射为 partOfSpeech 空字符串、lang=zh 的 meaning；若 basic 不存在则遍历 translation 数组，同样包装成 meanings。音标字段取 basic.phonetic/us-phonetic/uk-phonetic。"
    },
    "englishFreeDictionary": {
      "location": "backend/app/api/dictionary.py:162-226",
      "details": "query_free_dictionary 调用 https://api.dictionaryapi.dev/api/v2/entries/en/{word}（timeout=5s），解析 phonetic/phonetics 列表并遍历每个 meaning.definitions，把 definition/example 写入 meanings，同时标记 lang=en。"
    },
    "lookupPipeline": {
      "location": "backend/app/api/dictionary.py:372-462",
      "details": "lookup_word 先检查 _dictionary_cache（缓存 24 小时，定义于同文件 21-63 行），命中则直接返回。未命中时依次 await query_free_dictionary(word)；失败后使用 lemmatize_word（含不规则映射）重试；随后 await query_youdao_translate(word)。英文与中文请求是顺序执行的，最后把 meanings 合并、缺失音标时回退到中文结果，并通过 save_to_cache(word, result) 存储。"
    },
    "responseSchema": {
      "location": "backend/app/schemas/schemas.py:57-74",
      "details": "DictionaryResponse 定义 word、phonetic、meanings(List[dict])、audio、searched_word、lemma，前端过滤语言时依赖 meanings 中的 lang 字段（字典内自由扩展）。"
    }
  },
  "userSettings": {
    "storage": {
      "location": "frontend/src/services/storage.ts:1-114 & frontend/src/types.ts:47-78",
      "details": "settingsStorage 使用 localStorage 键 english_reading_settings 保存 ReaderSettings（font_size、line_height、theme）。ReaderPage 里的 showEnglish/showChinese/fontFamily/theme 目前直接通过 localStorage.getItem/setItem('showEnglish'...) 持久化，与 settingsStorage 分离。"
    },
    "settingsPanel": {
      "location": "frontend/src/components/ReaderPage.tsx:713-808",
      "details": "showSettings 控制的弹窗包含字体大小、字体样式、词典显示复选框等 UI，并调用 setFontSize/setFontFamily/setShowEnglish/setShowChinese 更新状态。"
    },
    "addingNewSetting": {
      "location": "frontend/src/stores/useAppStore.ts:1-138 & frontend/src/services/supabaseService.ts:326-385",
      "details": "新增设置需：1）在 ReaderSettings 接口与 settingsStorage 默认值中声明字段；2）在 supabaseService.settingsService.get/save/update 中读写 user_settings 表；3）在 useAppStore.updateSetting 中调用 settingsService.update，并在 ReaderPage 通过 store 或 localStorage 绑定输入控件。"
    }
  },
  "performance": {
    "cache": {
      "details": "_dictionary_cache（backend/app/api/dictionary.py:21-63）以内存字典缓存每个 word 的 DictionaryResponse，24 小时过期；前端缺少对应缓存，因此同一词语被重复点击时仍会触发一次 axios 请求，只能依赖后端缓存命中减压。"
    },
    "timeouts": {
      "details": "httpx 调用 Free Dictionary / 有道均设置 5s 超时，axios 客户端默认 10s。当前没有指数退避或更细粒度的 per-API 超时配置，也未并行请求从而缩短总体等待。"
    },
    "rendering": {
      "details": "ReaderPage 维护 selectedWord、wordDefinition、lookupLoading 等状态，导致整个阅读器（包括章节 HTML）在翻译响应到来时重新渲染；大章节内容通过 dangerouslySetInnerHTML 注入，频繁 setState 可能触发昂贵的重排。"
    },
    "apiSequencing": {
      "details": "lookup_word 顺序 await 英文 → 词形还原 → 中文，最坏情况需等待两个 5s 外部请求；前端 useEffect 也未添加去抖/取消，若用户快速多次点击会积压请求并导致响应乱序。"
    }
  },
  "observations": {
    "bottlenecks": [
      "后端串行调用 Free Dictionary 与有道（backend/app/api/dictionary.py:392-420），总延迟取决于更慢的那个 API，缺乏 asyncio.gather 并发或超时后的快速降级。",
      "ReaderPage 在 handleContentClick 中每次点击都 setSelectedWord，触发整个组件重渲染（frontend/src/components/ReaderPage.tsx:265-420），尚未使用 memo 或独立上下文隔离词典面板。",
      "前端没有缓存/取消逻辑，dictionaryAPI.lookup 每次返回的 Promise 可能在用户继续点击后才 resolve，造成无用的渲染和潜在的闪烁。"
    ],
    "chineseResultLimitation": "query_youdao_translate 只解析 basic.explains（每条映射为单个 definition 字符串），并未进一步拆分多义项或读取 web/webdict 字段，所以 UI 一次通常只能看到一条长字符串形式的中文释义（backend/app/api/dictionary.py:288-323 与 ReaderPage.tsx:1008-1054）。",
    "improvementIdeas": [
      "在 lookup_word 中使用 asyncio.gather 并发 Free Dictionary 与有道请求，并在任意一端失败时尽早返回可用结果。",
      "在前端给 selectedWord 查询增加简单缓存或 AbortController，避免重复请求同一个词；缓存可与 vocabularyStorage 类似维护在 sessionStorage。",
      "把 showEnglish/showChinese 等偏好托管到 settingsStorage/useAppStore，减少 ReaderPage 中散落的 localStorage 操作并为新增设置项复用逻辑。",
      "将词典面板提取成独立 memoized 组件，仅在 wordDefinition 变更时重渲染，降低大章节内容刷新频率。"
    ],
    "deepDiveSuggestions": [
      "抓取最近的 dictionaryAPI.lookup 日志，统计 Free Dictionary/有道分别的响应时间与失败率，用于确定是否需要批量预热或切换更稳定的字典源。",
      "梳理 ReaderPage 词典状态的 setState 链路，评估将词典抽成 Zustand slice 或使用 React.memo 的收益，并检查 dangerouslySetInnerHTML 是否触发额外布局。"
    ]
  }
}
