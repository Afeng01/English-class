# 数据库同步问题 - 上下文摘要
生成时间：2025-11-28

## 问题描述
- **现象**：本地环境有5本书，云端环境一本也没有
- **用户需求**：让本地和云端环境的书籍数据库同步

## 环境分析

### 本地环境
- **前端**：运行在 `localhost:5173`
- **后端**：运行在 `localhost:8000`
- **数据库**：SQLite (`backend/data/reading.db`)
- **API连接方式**：通过Vite代理 `/api` → `http://localhost:8000`
- **书籍数据**：5本书（已验证）
- **图片存储**：阿里云OSS (USE_OSS=true)

### 云端环境
- **前端部署**：Vercel（从 frontend/vercel.json 推断）
- **后端部署**：未知（需要确认）
- **API配置问题**：
  - `frontend/.env.local` 中**没有配置** `VITE_API_BASE_URL`
  - 生产环境前端会使用默认的 `/api`，但没有代理，**无法连接后端**
- **数据库状态**：可能是空的，或者根本没有部署后端

### 技术栈
- **前端**：React + Vite + TypeScript
- **后端**：FastAPI + SQLAlchemy
- **数据库**：SQLite（本地）
- **图片存储**：阿里云OSS
- **潜在云数据库**：Supabase（.env中已配置但未使用）

## 问题根源

1. **前端API配置缺失**：
   - 生产环境没有配置后端API地址（`VITE_API_BASE_URL`）
   - 导致云端前端无法连接到后端

2. **数据库隔离**：
   - 本地后端使用本地SQLite数据库
   - 云端后端（如果存在）使用独立的SQLite数据库
   - 两个数据库完全独立，不会自动同步

3. **部署架构不明确**：
   - 后端云端部署方式未知
   - 可能根本没有部署后端

## 解决方案

### 方案A：数据导出导入（快速但需手动）
**适用场景**：后端已部署，只需同步数据

**步骤**：
1. 从本地数据库导出书籍数据（SQL或JSON）
2. 将数据导入云端数据库
3. 配置前端的 `VITE_API_BASE_URL`

**优点**：
- 快速实施
- 保持现有架构

**缺点**：
- 每次上传新书都需要手动同步
- 不是长期解决方案

### 方案B：迁移到云数据库（推荐）
**适用场景**：需要长期同步解决方案

**步骤**：
1. 使用Supabase云数据库（.env中已有配置）
2. 修改后端代码，从SQLite迁移到PostgreSQL
3. 迁移现有数据到Supabase
4. 本地和云端都连接同一个Supabase数据库
5. 配置前端的 `VITE_API_BASE_URL`

**优点**：
- 一次配置，永久同步
- 多环境共享同一数据库
- 适合生产环境
- Supabase免费额度足够使用

**缺点**：
- 需要修改后端代码
- 需要数据库迁移

### 方案C：数据库文件直接上传（临时方案）
**适用场景**：快速测试，不推荐生产使用

**步骤**：
1. 将本地 `backend/data/reading.db` 上传到云端服务器
2. 确保云端后端可以访问该文件

**优点**：
- 最快速

**缺点**：
- 需要服务器文件系统访问权限
- Vercel等Serverless平台不支持
- 仍然无法解决长期同步问题

## 推荐方案

**方案B（迁移到Supabase云数据库）**是最佳选择，因为：
1. 彻底解决同步问题
2. 适合生产环境
3. Supabase配置已经准备好
4. 免费额度充足

## 需要的信息

1. 云端后端部署在哪里？（Vercel/Railway/Render/其他）
2. 是否愿意迁移到云数据库？（推荐）
3. 还是希望快速方案先解决当前问题？

## 关键文件路径

- 数据库文件：`backend/data/reading.db`
- 数据库配置：`backend/app/models/database.py:10`
- 前端API配置：`frontend/src/services/api.ts:7`
- 后端环境变量：`backend/.env`
- 前端环境变量：`frontend/.env.local`
