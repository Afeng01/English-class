# 需求深度分析报告

生成时间：2025-11-22
分析对象：单词点击问题 + 默认词库功能

---

## 一、需求解读

### 1.1 原始需求
1. **问题反馈**：点击单词（如ceiling）不显示正确含义
2. **功能建议**：添加默认词库功能，包含常见词（如the, apple等），用于在阅读时用不同颜色标注单词的熟悉程度

### 1.2 问题本质

#### 问题1：单词释义显示失败
**表象**：用户点击"ceiling"这个词，未显示释义

**可能的技术原因**：
| 假设 | 可能性 | 验证状态 |
|------|--------|----------|
| 外部词典API故障 | ❌ 低 | ✅ 已排除（测试API返回正常） |
| 前端单词提取错误 | ⚠️ 中 | 🔍 待验证（需添加日志） |
| 词形变化未处理 | ✅ 高 | ⚠️ 已确认（系统缺少词形还原） |
| 网络请求失败 | ⚠️ 低 | 🔍 待验证（需查看Network日志） |
| 特殊字符干扰 | ⚠️ 中 | 🔍 待验证（HTML可能含隐藏字符） |

**初步诊断**：
- ✅ **外部API正常**：通过直接请求 `https://api.dictionaryapi.dev/api/v2/entries/en/ceiling` 验证，返回完整释义数据
- ⚠️ **可能是词形问题**：如果用户点击的是"ceiling"的其他形式（虽然ceiling本身没有复数），或者HTML渲染中包含特殊字符
- ⚠️ **可能是前端清理逻辑问题**：`word.replace(/[^a-zA-Z]/g, '')` 可能无法处理某些特殊场景

#### 问题2：默认词库功能需求
**本质需求**：
1. **词汇分级体系**：建立基础词/常见词/高级词的分类标准
2. **视觉反馈系统**：通过颜色编码快速识别单词难度
3. **个性化学习路径**：根据词汇等级引导学习重点

**核心价值**：
- 降低阅读心理负担（知道哪些词可以跳过）
- 提高学习效率（聚焦生词）
- 提供学习进度可视化

---

## 二、技术架构分析

### 2.1 当前系统架构

#### 数据流图（单词点击功能）
```
用户点击单词
    ↓
前端提取单词文本 (textContent)
    ↓
前端清理单词 (/[^a-zA-Z]/g + toLowerCase)
    ↓
前端调用API (GET /api/dictionary/{word})
    ↓
后端接收请求 (FastAPI)
    ↓
后端代理请求 (httpx → Free Dictionary API)
    ↓
第三方API返回数据 (JSON)
    ↓
后端解析数据 (提取音标、释义、音频)
    ↓
前端接收响应
    ↓
前端显示弹窗 (包含释义、音标、音频、加入生词本按钮)
```

#### 关键代码位置
| 功能模块 | 文件路径 | 行数 | 说明 |
|---------|---------|------|------|
| 单词点击事件 | `frontend/src/pages/ReaderPage.tsx` | 80-103 | handleWordClick 函数 |
| 词典API调用 | `frontend/src/services/api.ts` | 33-36 | dictionaryAPI.lookup |
| 后端词典路由 | `backend/app/api/dictionary.py` | 11-72 | lookup_word API |
| 词典弹窗显示 | `frontend/src/pages/ReaderPage.tsx` | 352-405 | 条件渲染组件 |
| 数据类型定义 | `frontend/src/types/index.ts` | 38-49 | DictionaryResult |

### 2.2 发现的架构问题

#### 问题1：缺少词形还原（Lemmatization）
**影响范围**：所有词形变化的单词查询都会失败

**示例**：
- `ceilings` → 查询失败（应还原为 `ceiling`）
- `went` → 查询失败（应还原为 `go`）
- `running` → 查询失败（应还原为 `run`）
- `children` → 查询失败（应还原为 `child`）

**根本原因**：
- 前端仅做简单清理（去除标点、转小写）
- 后端直接透传单词，未做语言学处理
- 第三方API（Free Dictionary API）仅支持原形单词精确匹配

**修复方案**：
```python
# 后端集成词形还原库
from lemminflect import getLemma

@router.get("/{word}")
async def lookup_word(word: str):
    # 词形还原
    lemmatized = getLemma(word, 'VERB')  # 尝试动词
    if not lemmatized:
        lemmatized = getLemma(word, 'NOUN')  # 尝试名词
    search_word = lemmatized[0] if lemmatized else word

    # 使用还原后的单词查询
    response = await client.get(f"{FREE_DICTIONARY_API}/{search_word}")
```

#### 问题2：错误信息不明确
**当前行为**：无论是"API错误"还是"单词不存在"，都显示"未找到释义"

**改进建议**：
```tsx
// 前端区分错误类型
catch (error) {
  if (error.response?.status === 404) {
    setWordResult({ error: "词典中未找到此单词" });
  } else if (error.response?.status >= 500) {
    setWordResult({ error: "词典服务暂时不可用" });
  } else {
    setWordResult({ error: "查询失败，请稍后重试" });
  }
}
```

#### 问题3：缺少默认词库数据模型
**当前状态**：数据库没有预设词汇等级表

**需要新增**：
```python
# backend/app/models/database.py
class DefaultVocabulary(Base):
    __tablename__ = "default_vocabulary"

    word = Column(String, primary_key=True)
    level = Column(String)  # 'basic', 'common', 'advanced'
    frequency_rank = Column(Integer)  # 词频排名（1-5000）
    category = Column(String)  # 词表来源（COCA/GSL/Oxford）
```

---

## 三、关键技术疑问（按优先级排序）

### 高优先级（P0）- 必须立即解决

#### [P0-1] ceiling 为何不显示释义？
**疑问**：用户报告的具体场景是什么？
- 是每次点击 ceiling 都不显示？
- 还是只有特定位置的 ceiling 不显示？
- 其他单词是否正常？

**所需信息**：
- 浏览器 Console 日志（查看请求参数）
- Network 面板截图（查看请求/响应）
- 点击位置的 HTML 源码

**验证步骤**：
1. 在 `handleWordClick` 开头添加：`console.log('Clicked word:', cleanWord)`
2. 复现问题，查看 Console 输出
3. 对比实际传递的单词和预期的单词

#### [P0-2] 词形还原应该在前端还是后端？
**方案对比**：

| 方案 | 优势 | 劣势 |
|------|------|------|
| 前端还原 | 减少后端压力、响应更快 | 增加前端bundle大小、词库需下载 |
| 后端还原 | 集中处理、易于维护 | 增加API延迟、后端负载增加 |

**推荐方案**：**后端还原**
- 理由1：词形还原库（如 nltk、lemminflect）体积较大，不适合前端
- 理由2：后端已经是代理模式，增加预处理步骤符合架构
- 理由3：便于统一管理和升级词形还原逻辑

#### [P0-3] 词形还原库选择
**Python 选项**：
| 库名 | 优势 | 劣势 |
|------|------|------|
| **lemminflect** | 准确率高、支持词性标注 | 需要安装、启动稍慢 |
| **nltk** | 功能全面、社区活跃 | 需下载数据包、体积大 |
| **spaCy** | 性能最佳、NLP全能 | 模型文件大（>100MB） |

**推荐方案**：**lemminflect**
- 理由：轻量、准确率高、无需额外数据下载

### 中优先级（P1）- 影响设计决策

#### [P1-1] 默认词库的数据来源
**开源词表选项**：
| 词表名称 | 词汇量 | 优势 | 劣势 |
|---------|--------|------|------|
| **General Service List (GSL)** | 2000 | 经典、覆盖日常英语 | 较老（1953年） |
| **COCA 5000** | 5000 | 基于语料库、现代英语 | 需处理版权 |
| **Oxford 3000** | 3000 | 权威、适合学习者 | 版权限制严格 |
| **New General Service List (NGSL)** | 2800 | 开源、更新频繁 | ✅ 推荐使用 |

**推荐方案**：**NGSL + NAWL**
- NGSL（New General Service List）：2800个基础词
- NAWL（New Academic Word List）：963个学术词
- 优势：开源、免费、现代英语、覆盖广

#### [P1-2] 颜色标注的性能影响
**挑战**：一个章节可能包含 1000+ 单词，逐词标注会影响渲染性能

**优化方案**：
1. **预处理**：在加载章节时批量查询所有单词的等级
2. **缓存**：使用 Map 存储 `word → level` 映射
3. **虚拟DOM优化**：使用 `useMemo` 缓存标注后的内容
4. **分批渲染**：超长章节分段渲染

**性能测试**：
- 目标：1000词章节的标注渲染 < 500ms
- 测试工具：React DevTools Profiler

#### [P1-3] 词库等级分类标准
**建议方案**：
```typescript
// 4级分类
type WordLevel = 'basic' | 'common' | 'advanced' | 'unknown';

// 映射关系
const levelMapping = {
  'basic': 'NGSL 1-500',     // 最基础500词
  'common': 'NGSL 501-2800', // 常见词
  'advanced': 'NAWL 1-963',  // 学术词
  'unknown': '词表外'         // 超纲词/专有名词
};

// 颜色方案（考虑色盲友好）
const levelColors = {
  'basic': 'text-gray-400',      // 灰色（可忽略）
  'common': 'text-blue-600',     // 蓝色（应该认识）
  'advanced': 'text-orange-600', // 橙色（需要学习）
  'unknown': 'text-red-600'      // 红色（生词）
};
```

### 低优先级（P2）- 优化方向

#### [P2-1] 离线词典支持
**动机**：减少对外部 API 依赖
**方案**：自建 SQLite 词典数据库（使用 Wiktionary 数据）
**成本**：数据库大小约 200-500MB

#### [P2-2] 个性化词库
**功能**：根据用户已掌握的单词动态调整颜色
**数据模型**：
```python
class UserVocabularyMastery(Base):
    user_id = Column(String)
    word = Column(String)
    mastery_level = Column(Integer)  # 1-5 星
    last_reviewed = Column(DateTime)
```

---

## 四、实现方案建议

### 方案A：快速修复（问题1）
**目标**：尽快解决 ceiling 不显示问题

**步骤**：
1. 添加前端调试日志（1小时）
2. 复现问题，定位根本原因（1小时）
3. 后端集成 lemminflect 词形还原（2小时）
4. 测试验证（1小时）

**预期工期**：半天

### 方案B：完整实现（问题1 + 问题2）
**目标**：同时解决问题1，并实现默认词库功能

**阶段1：修复词形还原（2-3天）**
1. 后端集成 lemminflect
2. 修改 lookup_word API
3. 添加单元测试（测试各种词形）
4. 前端优化错误提示

**阶段2：默认词库基础功能（3-5天）**
1. 下载并处理 NGSL + NAWL 词表
2. 数据库 schema 设计和导入
3. 实现批量词汇等级查询 API
   ```python
   @router.post("/batch-level")
   async def batch_check_level(words: List[str]):
       # 批量查询词汇等级
       results = db.query(DefaultVocabulary).filter(
           DefaultVocabulary.word.in_(words)
       ).all()
       return {r.word: r.level for r in results}
   ```
4. 前端预处理和标注渲染
5. 性能优化和测试

**阶段3：UI增强（2-3天）**
1. 设置面板：允许用户自定义颜色和等级
2. 词汇统计：显示章节中各等级单词占比
3. 交互优化：点击标注单词时优先显示等级信息

**预期工期**：1-2周

### 方案C：分步迭代（推荐）
**目标**：先解决核心问题，再逐步增强

**第一步（本周）**：
- 修复词形还原问题
- 添加详细的错误提示

**第二步（下周）**：
- 实现默认词库基础功能
- 仅支持颜色标注，不提供自定义

**第三步（后续）**：
- 添加个性化设置
- 实现离线词典

**优势**：
- 快速见效（用户能立即看到改进）
- 降低风险（分阶段验证）
- 便于调整（根据反馈迭代）

---

## 五、风险评估

### 技术风险
| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|----------|
| 词形还原准确率低 | 中 | 中 | 使用多个库对比，记录失败案例 |
| 词库版权问题 | 低 | 高 | 仅使用开源词表（NGSL/NAWL） |
| 性能问题（大章节） | 中 | 中 | 预处理+缓存+分批渲染 |
| 第三方API稳定性 | 低 | 中 | 添加重试机制，考虑离线词典 |

### 产品风险
| 风险项 | 概率 | 影响 | 缓解措施 |
|--------|------|------|----------|
| 颜色标注干扰阅读 | 中 | 中 | 提供开关选项，默认关闭 |
| 词汇等级标准不符预期 | 中 | 低 | 允许用户自定义等级 |
| 专有名词误标 | 高 | 低 | 添加专有名词过滤规则 |

---

## 六、推荐行动路径

### 立即行动（今天）
1. ✅ **完成需求分析**（当前文档）
2. 🔍 **与用户确认**：
   - 能否复现"ceiling不显示"问题？
   - 如果能，请提供 Console 日志和 Network 截图
   - 确认默认词库功能的优先级（是否必须本周完成）

### 短期计划（本周）
3. 🛠️ **修复词形还原问题**：
   - 后端集成 lemminflect
   - 添加单元测试
   - 前端优化错误提示
4. 📊 **准备词库数据**：
   - 下载 NGSL + NAWL
   - 设计数据库 schema
   - 编写导入脚本

### 中期计划（下周）
5. 🎨 **实现词库标注功能**：
   - 批量查询 API
   - 前端预处理和渲染
   - 性能优化
6. 🧪 **完整测试**：
   - 单元测试（词形还原、等级查询）
   - 集成测试（端到端流程）
   - 性能测试（大章节渲染）

### 长期规划（后续迭代）
7. 💡 **增强功能**：
   - 个性化词库
   - 离线词典
   - 学习进度追踪

---

## 七、需要的外部输入

### 来自用户
- [ ] "ceiling不显示"问题的复现步骤
- [ ] 浏览器 Console 日志
- [ ] Network 面板截图
- [ ] 对默认词库功能的期望（颜色方案、等级划分）

### 来自技术调研
- [ ] lemminflect 库的安装和使用验证
- [ ] NGSL/NAWL 词表的下载和格式确认
- [ ] 性能基准测试（1000词章节的渲染时间）

---

## 八、总结

### 问题1诊断结果
- **外部API正常**（已验证）
- **系统缺少词形还原**（已确认）
- **需要用户提供更多信息**（等待复现）

### 问题2设计建议
- **词表选择**：NGSL + NAWL（开源、现代、覆盖广）
- **颜色方案**：4级分类（灰/蓝/橙/红）
- **技术方案**：数据库 + 批量API + 前端预处理
- **性能目标**：1000词章节标注 < 500ms

### 下一步关键决策
1. 是否采用"分步迭代"方案？（推荐）
2. 词形还原放在前端还是后端？（推荐后端）
3. 是否需要用户提供更多"ceiling问题"的信息？（推荐）

---

**文档版本**：v1.0
**作者**：Claude Code
**审查状态**：待用户反馈
