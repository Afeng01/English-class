# å·¥ä½œæ€»ç»“ - 2025-11-26
# ç”¨æˆ·è®¤è¯ä¸äº‘ç«¯æ•°æ®åŒæ­¥åŠŸèƒ½å®ç°

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç°å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿå’Œäº‘ç«¯æ•°æ®åŒæ­¥åŠŸèƒ½ï¼Œæ”¯æŒGoogle OAuthç™»å½•å’ŒSupabaseäº‘ç«¯å­˜å‚¨ï¼Œå®ç°å¤šè®¾å¤‡æ•°æ®åŒæ­¥ã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### é˜¶æ®µ1ï¼šSupabaseé¡¹ç›®é…ç½®

#### 1.1 åˆ›å»ºSupabaseé¡¹ç›®
- åœ¨ [Supabase](https://supabase.com/) åˆ›å»ºæ–°é¡¹ç›®
- é…ç½®é¡¹ç›®åç§°ã€æ•°æ®åº“å¯†ç ã€åŒºåŸŸ
- è·å–é¡¹ç›®URLå’ŒAPI Keysï¼ˆAnon Keyå’ŒService Role Keyï¼‰

#### 1.2 é…ç½®Google OAuth
- åœ¨ [Google Cloud Console](https://console.cloud.google.com/) åˆ›å»ºOAuth 2.0å®¢æˆ·ç«¯
- é…ç½®æˆæƒæ¥æºï¼š`http://localhost:5176`
- é…ç½®å›è°ƒURIï¼š`https://zxbijuzcrjdstgfzukfq.supabase.co/auth/v1/callback`
- åœ¨Supabaseä¸­å¯ç”¨Google Providerå¹¶é…ç½®Client IDå’ŒSecret

#### 1.3 åˆ›å»ºæ•°æ®åº“Schema
æ‰§è¡Œä»¥ä¸‹SQLåˆ›å»ºè¡¨å’ŒRLSç­–ç•¥ï¼š

**ç”¨æˆ·è¯æ±‡è¡¨ï¼ˆuser_vocabularyï¼‰ï¼š**
```sql
CREATE TABLE user_vocabulary (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  word VARCHAR(100) NOT NULL,
  phonetic VARCHAR(200),
  definition TEXT,
  status VARCHAR(20) CHECK (status IN ('learning', 'mastered')),
  added_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, word)
);

ALTER TABLE user_vocabulary ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own vocabulary"
  ON user_vocabulary FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own vocabulary"
  ON user_vocabulary FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own vocabulary"
  ON user_vocabulary FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own vocabulary"
  ON user_vocabulary FOR DELETE USING (auth.uid() = user_id);
```

**é˜…è¯»è¿›åº¦è¡¨ï¼ˆreading_progressï¼‰ï¼š**
```sql
CREATE TABLE reading_progress (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  book_id VARCHAR(100) NOT NULL,
  chapter_number INTEGER NOT NULL,
  last_read_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, book_id)
);

ALTER TABLE reading_progress ENABLE ROW LEVEL SECURITY;
-- RLSç­–ç•¥ï¼ˆåŒuser_vocabularyï¼‰
```

**ç”¨æˆ·è®¾ç½®è¡¨ï¼ˆuser_settingsï¼‰ï¼š**
```sql
CREATE TABLE user_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  font_size VARCHAR(20) DEFAULT 'medium',
  line_height NUMERIC DEFAULT 1.8,
  theme VARCHAR(20) DEFAULT 'light',
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE user_settings ENABLE ROW LEVEL SECURITY;
-- RLSç­–ç•¥ï¼ˆåŒuser_vocabularyï¼‰
```

**ä¹¦ç±è¡¨ï¼ˆbooksï¼‰** - å…¨å±€å…±äº«ï¼Œæ— RLSï¼š
```sql
CREATE TABLE books (
  id VARCHAR(100) PRIMARY KEY,
  title VARCHAR(500) NOT NULL,
  author VARCHAR(200),
  cover TEXT,
  level VARCHAR(50),
  word_count INTEGER DEFAULT 0,
  description TEXT,
  epub_path TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ç« èŠ‚è¡¨ï¼ˆchaptersï¼‰å’Œè¯æ±‡è¡¨ï¼ˆbook_vocabularyï¼‰** - åŒæ ·å…¨å±€å…±äº«ã€‚

---

### é˜¶æ®µ2ï¼šå‰ç«¯è®¤è¯å®ç°

#### 2.1 Supabaseå®¢æˆ·ç«¯é…ç½®
**æ–‡ä»¶ï¼š** `frontend/.env.local`
```env
VITE_SUPABASE_URL=https://zxbijuzcrjdstgfzukfq.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**æ–‡ä»¶ï¼š** `frontend/src/lib/supabase.ts`
```typescript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionFromUrl: true,
  },
})
```

#### 2.2 è®¤è¯çŠ¶æ€ç®¡ç†
**æ–‡ä»¶ï¼š** `frontend/src/stores/useAuthStore.ts`

- ä½¿ç”¨Zustandç®¡ç†è®¤è¯çŠ¶æ€
- å®ç°`initialize()`, `signInWithGoogle()`, `signOut()`æ–¹æ³•
- ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–ï¼Œè‡ªåŠ¨è§¦å‘æ•°æ®è¿ç§»

#### 2.3 ç™»å½•é¡µé¢
**æ–‡ä»¶ï¼š** `frontend/src/components/LoginPage.tsx`

- ç²¾ç¾çš„æ¸å˜èƒŒæ™¯è®¾è®¡
- Googleç™»å½•æŒ‰é’®ï¼ˆå¸¦Google Logo SVGï¼‰
- ç‚¹å‡»åé€šè¿‡Supabase OAuthæµç¨‹ç™»å½•

#### 2.4 OAuthå›è°ƒå¤„ç†
**æ–‡ä»¶ï¼š** `frontend/src/components/AuthCallback.tsx`

- å¤„ç†Google OAuthå›è°ƒ
- ç™»å½•æˆåŠŸåé‡å®šå‘åˆ°é¦–é¡µ

#### 2.5 è·¯ç”±ä¿æŠ¤
**æ–‡ä»¶ï¼š** `frontend/src/components/ProtectedRoute.tsx`

- æ£€æŸ¥è®¤è¯çŠ¶æ€
- æœªç™»å½•æ—¶é‡å®šå‘åˆ°ç™»å½•é¡µï¼ˆä»…ç”¨äº/vocabé¡µé¢ï¼‰

#### 2.6 å¯¼èˆªæ é›†æˆ
**æ–‡ä»¶ï¼š** `frontend/src/components/Navigation.tsx`

- ç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç”¨æˆ·å¤´åƒ/é¦–å­—æ¯
- ä¸‹æ‹‰èœå•ï¼šç”¨æˆ·ä¿¡æ¯ã€é€€å‡ºç™»å½•
- æœªç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç™»å½•æŒ‰é’®

---

### é˜¶æ®µ3ï¼šå‰ç«¯æ•°æ®åŒæ­¥

#### 3.1 Supabaseæ•°æ®æœåŠ¡å±‚
**æ–‡ä»¶ï¼š** `frontend/src/services/supabaseService.ts`

å®ç°ä¸‰å¤§æœåŠ¡æ¨¡å—ï¼š

**vocabularyService** - è¯æ±‡ç®¡ç†ï¼š
- `getAll()` - è·å–æ‰€æœ‰è¯æ±‡
- `add()` - æ·»åŠ è¯æ±‡
- `remove()` - åˆ é™¤è¯æ±‡
- `updateStatus()` - æ›´æ–°å­¦ä¹ çŠ¶æ€
- `bulkAdd()` - æ‰¹é‡æ·»åŠ ï¼ˆç”¨äºè¿ç§»ï¼‰

**progressService** - è¿›åº¦ç®¡ç†ï¼š
- `getAll()` - è·å–æ‰€æœ‰è¿›åº¦
- `get()` - è·å–æŒ‡å®šä¹¦ç±è¿›åº¦
- `save()` - ä¿å­˜è¿›åº¦
- `bulkSave()` - æ‰¹é‡ä¿å­˜ï¼ˆç”¨äºè¿ç§»ï¼‰

**settingsService** - è®¾ç½®ç®¡ç†ï¼š
- `get()` - è·å–è®¾ç½®
- `save()` - ä¿å­˜è®¾ç½®
- `update()` - æ›´æ–°å•ä¸ªè®¾ç½®é¡¹

#### 3.2 è‡ªåŠ¨æ•°æ®è¿ç§»
**æ–‡ä»¶ï¼š** `frontend/src/services/dataMigration.ts`

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- æ£€æµ‹localStorageä¸­çš„å†å²æ•°æ®
- ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨è¿ç§»åˆ°Supabase
- è¿ç§»å®Œæˆåæ ‡è®°ï¼Œé¿å…é‡å¤è¿ç§»
- é™é»˜è¿ç§»ï¼Œä»…åœ¨æ§åˆ¶å°è¾“å‡ºæ—¥å¿—

**è¿ç§»å†…å®¹ï¼š**
- ç”Ÿè¯æœ¬æ•°æ®
- é˜…è¯»è¿›åº¦
- ä¸ªæ€§åŒ–è®¾ç½®

**å®ç°ç»†èŠ‚ï¼š**
```typescript
export const autoMigrateOnLogin = async (): Promise<void> => {
  if (isMigrated()) {
    console.log('æ•°æ®å·²è¿ç§»ï¼Œæ— éœ€é‡å¤è¿ç§»')
    return
  }

  const hasLocalData = vocabularyStorage.getAll().length > 0 ||
                       Object.keys(progressStorage.getAll()).length > 0

  if (!hasLocalData) {
    markMigrated()
    return
  }

  console.log('æ£€æµ‹åˆ°æœ¬åœ°æ•°æ®ï¼Œå¼€å§‹è‡ªåŠ¨è¿ç§»...')
  const result = await migrateLocalData()

  if (result.success) {
    console.log(`âœ… æ•°æ®è¿ç§»æˆåŠŸï¼
è¯æ±‡ï¼š${result.vocabularyMigrated} ä¸ª
é˜…è¯»è¿›åº¦ï¼š${result.progressMigrated} ä¸ª
è®¾ç½®ï¼š${result.settingsMigrated ? 'å·²è¿ç§»' : 'æœªè¿ç§»'}`)
  }
}
```

#### 3.3 é‡æ„åº”ç”¨çŠ¶æ€ç®¡ç†
**æ–‡ä»¶ï¼š** `frontend/src/stores/useAppStore.ts`

**æ”¹åŠ¨ï¼š**
- æ‰€æœ‰æ–¹æ³•ä»åŒæ­¥æ”¹ä¸ºå¼‚æ­¥
- é›†æˆSupabaseæœåŠ¡
- å®ç°graceful degradationï¼ˆSupabaseå¤±è´¥æ—¶fallbackåˆ°localStorageï¼‰

**ç¤ºä¾‹ï¼š**
```typescript
addWord: async (word) => {
  try {
    const success = await vocabularyService.add(word);
    if (success) {
      await get().loadVocabulary();
      return true;
    }
    return false;
  } catch (error) {
    console.error('ä¿å­˜åˆ°Supabaseå¤±è´¥ï¼Œä½¿ç”¨localStorage:', error);
    vocabularyStorage.add(word);
    await get().loadVocabulary();
    return true;
  }
}
```

#### 3.4 æ›´æ–°ç»„ä»¶ä½¿ç”¨å¼‚æ­¥æ–¹æ³•
**ä¿®æ”¹çš„ç»„ä»¶ï¼š**
- `VocabPage.tsx` - è¯æ±‡é¡µé¢
- `ReaderPage.tsx` - é˜…è¯»å™¨é¡µé¢
- æ‰€æœ‰`onClick`äº‹ä»¶æ”¹ä¸º`async`å‡½æ•°

---

### é˜¶æ®µ4ï¼šåç«¯Supabaseé›†æˆ

#### 4.1 å®‰è£…ä¾èµ–
```bash
pip install supabase==2.12.0
```

#### 4.2 ç¯å¢ƒå˜é‡é…ç½®
**æ–‡ä»¶ï¼š** `backend/.env.example`ï¼ˆå·²è¿½åŠ ï¼‰
```env
# ==================== Supabaseé…ç½®ï¼ˆå¿…éœ€ï¼‰====================
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_KEY=your_service_role_key_here

# âš ï¸ æ³¨æ„ï¼šè¿™æ˜¯Service Role Keyï¼Œä¸æ˜¯Anon Keyï¼
# åç«¯ä½¿ç”¨Service Role Keyå¯ä»¥ç»•è¿‡RLSç›´æ¥è®¿é—®æ‰€æœ‰æ•°æ®
```

#### 4.3 Python Supabaseå®¢æˆ·ç«¯
**æ–‡ä»¶ï¼š** `backend/app/utils/supabase_client.py`

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- å•ä¾‹æ¨¡å¼
- è‡ªåŠ¨æ£€æµ‹é…ç½®æ˜¯å¦å¯ç”¨
- æä¾›ä¹¦ç±ã€ç« èŠ‚ã€è¯æ±‡çš„CRUDæ“ä½œ
- æ”¯æŒæ‰¹é‡æ’å…¥ï¼ˆbulk insertï¼‰

**å…³é”®æ–¹æ³•ï¼š**
```python
class SupabaseClient:
    def insert_book(self, book_data: Dict[str, Any]) -> bool
    def bulk_insert_chapters(self, chapters_data: List[Dict]) -> bool
    def bulk_insert_vocabulary(self, vocab_data: List[Dict]) -> bool
    def get_book(self, book_id: str) -> Optional[Dict]
    def list_books(self, level: Optional[str] = None) -> List[Dict]
    def delete_book(self, book_id: str) -> bool
```

#### 4.4 ä¿®æ”¹ä¹¦ç±å¯¼å…¥è„šæœ¬
**æ–‡ä»¶ï¼š** `backend/scripts/import_book.py`

**æ”¹åŠ¨ï¼š**
```python
from app.utils.supabase_client import supabase_client

# åœ¨SQLiteæäº¤åï¼ŒåŒæ­¥åˆ°Supabase
db.commit()

if supabase_client.enabled:
    try:
        logger.info("ğŸ“¤ å¼€å§‹åŒæ­¥æ•°æ®åˆ°Supabase...")

        # 1. æ’å…¥ä¹¦ç±
        supabase_client.insert_book(book_data_for_supabase)

        # 2. æ‰¹é‡æ’å…¥ç« èŠ‚
        supabase_client.bulk_insert_chapters(chapters_for_supabase)

        # 3. æ‰¹é‡æ’å…¥è¯æ±‡
        supabase_client.bulk_insert_vocabulary(vocab_for_supabase)

        logger.info("âœ… æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°Supabase")
    except Exception as e:
        logger.warning(f"âš ï¸ SupabaseåŒæ­¥å¤±è´¥ï¼ˆä¸å½±å“æœ¬åœ°SQLiteï¼‰: {e}")
```

**å®ç°ç­–ç•¥ï¼š**
- åŒå†™ï¼ˆDual-Writeï¼‰ï¼šåŒæ—¶å†™å…¥SQLiteå’ŒSupabase
- SQLiteä½œä¸ºä¸»æ•°æ®æºï¼ˆå‘åå…¼å®¹ï¼‰
- SupabaseåŒæ­¥å¤±è´¥ä¸å½±å“æœ¬åœ°åŠŸèƒ½

#### 4.5 æ•°æ®è¿ç§»è„šæœ¬
**æ–‡ä»¶ï¼š** `backend/scripts/migrate_to_supabase.py`

**åŠŸèƒ½ï¼š**
- è¯»å–SQLiteä¸­çš„æ‰€æœ‰ä¹¦ç±æ•°æ®
- æ‰¹é‡ä¸Šä¼ åˆ°Supabaseï¼ˆç« èŠ‚æ¯æ‰¹100ä¸ªï¼Œè¯æ±‡æ¯æ‰¹200ä¸ªï¼‰
- æä¾›è¯¦ç»†çš„è¿ç§»ç»Ÿè®¡
- æ”¯æŒdry-runæ¨¡å¼ï¼ˆæ¨¡æ‹Ÿè¿è¡Œï¼‰
- è¿ç§»åéªŒè¯æ•°æ®å®Œæ•´æ€§

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
# æ¨¡æ‹Ÿè¿è¡Œ
python scripts/migrate_to_supabase.py --dry-run

# å®é™…è¿ç§»
python scripts/migrate_to_supabase.py

# è·³è¿‡éªŒè¯ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰
python scripts/migrate_to_supabase.py --skip-verification
```

**è¿ç§»ç»Ÿè®¡ç¤ºä¾‹ï¼š**
```
==============================================================
ğŸ“Š è¿ç§»ç»Ÿè®¡æ‘˜è¦
==============================================================
ğŸ“š ä¹¦ç±: 2/2 æˆåŠŸ, 0 å¤±è´¥
ğŸ“– ç« èŠ‚: 27/27 æˆåŠŸ, 0 å¤±è´¥
ğŸ“ è¯æ±‡: 200/200 æˆåŠŸ, 0 å¤±è´¥
==============================================================
```

---

### é˜¶æ®µ5ï¼šUIä¼˜åŒ–å’Œé”™è¯¯å¤„ç†

#### 5.1 è·¯ç”±ä¿æŠ¤é€»è¾‘ä¼˜åŒ–
**æ–‡ä»¶ï¼š** `frontend/src/App.tsx`

**ä¿®æ”¹å‰ï¼š**
- æ‰€æœ‰é¡µé¢éƒ½éœ€è¦ç™»å½•ï¼ˆshelf, reader, vocab, uploadï¼‰

**ä¿®æ”¹åï¼š**
```typescript
{/* å…¬å¼€è·¯ç”± - ä¸éœ€è¦ç™»å½• */}
<Route path="/" element={<HomePage isLoggedIn={!!user} />} />
<Route path="/shelf" element={<ShelfPage />} />
<Route path="/book/:id" element={<BookDetailPage />} />
<Route path="/reader" element={<ReaderPage />} />

{/* éœ€è¦è®¤è¯çš„è·¯ç”± - åªæœ‰ç”¨æˆ·æ•°æ®ç›¸å…³çš„é¡µé¢ */}
<Route path="/vocab" element={<ProtectedRoute><VocabPage /></ProtectedRoute>} />
<Route path="/upload" element={<UploadPage />} />
```

**è®¾è®¡ç†å¿µï¼š**
- ä¹¦ç±æ•°æ®æ˜¯å…¨å±€å…±äº«çš„ï¼Œæ— éœ€ç™»å½•å³å¯é˜…è¯»
- åªæœ‰ä¸ªäººæ•°æ®ï¼ˆç”Ÿè¯æœ¬ï¼‰éœ€è¦ç™»å½•ä¿æŠ¤
- ä¸Šä¼ åŠŸèƒ½åœ¨ç»„ä»¶å†…éƒ¨æ£€æŸ¥ç™»å½•çŠ¶æ€

#### 5.2 æ·»åŠ ç”Ÿè¯çš„ç™»å½•æ£€æŸ¥å’Œåé¦ˆ
**æ–‡ä»¶ï¼š** `frontend/src/components/ReaderPage.tsx`

**æ·»åŠ çŠ¶æ€ï¼š**
```typescript
const { user } = useAuthStore();
const [wordAdded, setWordAdded] = useState(false);
```

**ä¿®æ”¹handleAddWordï¼š**
```typescript
const handleAddWord = async () => {
  if (!wordDefinition) return;

  // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  if (!user) {
    alert('è¯·ç™»å½•åä½¿ç”¨ç”Ÿè¯æœ¬åŠŸèƒ½');
    return;
  }

  const success = await addWord({...});

  // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
  if (success) {
    setWordAdded(true);
    setTimeout(() => setWordAdded(false), 2000);
  }
};
```

**æŒ‰é’®UIåé¦ˆï¼š**
```typescript
<button
  className={`
    ${wordAdded ? 'bg-green-500 text-white' : '...'}
  `}
>
  {wordAdded ? (
    <>
      <Check className="w-4 h-4" />
      å·²æ·»åŠ 
    </>
  ) : (
    <>
      <Plus className="w-4 h-4" />
      {vocabularyStorage.has(word) ? 'å·²åœ¨ç”Ÿè¯æœ¬' : 'åŠ å…¥ç”Ÿè¯æœ¬'}
    </>
  )}
</button>
```

**æ•ˆæœï¼š**
- æœªç™»å½•ç‚¹å‡»ï¼šå¼¹çª—æç¤º"è¯·ç™»å½•åä½¿ç”¨ç”Ÿè¯æœ¬åŠŸèƒ½"
- æ·»åŠ æˆåŠŸï¼šæŒ‰é’®å˜ç»¿è‰²ï¼Œæ˜¾ç¤º"å·²æ·»åŠ " + âœ“å›¾æ ‡ï¼Œ2ç§’åæ¢å¤

#### 5.3 ä¸Šä¼ é¡µé¢ç™»å½•æ£€æŸ¥
**æ–‡ä»¶ï¼š** `frontend/src/components/UploadPage.tsx`

**æ·»åŠ ç™»å½•æ£€æŸ¥ï¼š**
```typescript
import { useAuthStore } from '../stores/useAuthStore';

export default function UploadPage() {
  const { user } = useAuthStore();

  useEffect(() => {
    if (!user) {
      alert('è¯·ç™»å½•åå†ä½¿ç”¨è¯¥åŠŸèƒ½');
      navigate('/');
    }
  }, [user, navigate]);

  // ... å…¶ä½™ä»£ç 
}
```

**ç§»é™¤è·¯ç”±å±‚çš„ProtectedRouteï¼š**
```typescript
// App.tsxä¸­ç§»é™¤ProtectedRouteåŒ…è£…
<Route path="/upload" element={<UploadPage />} />
```

**æ•ˆæœï¼š**
- æœªç™»å½•è®¿é—®ï¼šå¼¹çª—æç¤º"è¯·ç™»å½•åå†ä½¿ç”¨è¯¥åŠŸèƒ½"ï¼Œç„¶åè¿”å›é¦–é¡µ
- ç”¨æˆ·ä½“éªŒæ›´å‹å¥½ï¼Œä¸ä¼šç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µ

#### 5.4 é™é»˜æ•°æ®è¿ç§»
**æ–‡ä»¶ï¼š** `frontend/src/services/dataMigration.ts`

**ä¿®æ”¹å‰ï¼š**
```typescript
if (result.success) {
  alert(`æ•°æ®è¿ç§»æˆåŠŸï¼
è¯æ±‡ï¼š${result.vocabularyMigrated} ä¸ª
é˜…è¯»è¿›åº¦ï¼š${result.progressMigrated} ä¸ª
è®¾ç½®ï¼š${result.settingsMigrated ? 'å·²è¿ç§»' : 'æœªè¿ç§»'}`);
}
```

**ä¿®æ”¹åï¼š**
```typescript
if (result.success) {
  console.log(`âœ… æ•°æ®è¿ç§»æˆåŠŸï¼
è¯æ±‡ï¼š${result.vocabularyMigrated} ä¸ª
é˜…è¯»è¿›åº¦ï¼š${result.progressMigrated} ä¸ª
è®¾ç½®ï¼š${result.settingsMigrated ? 'å·²è¿ç§»' : 'æœªè¿ç§»'}`);
}
```

**æ•ˆæœï¼š**
- ç”¨æˆ·ç™»å½•æ—¶ä¸å†çœ‹åˆ°å¼¹çª—æ‰“æ–­
- è¿ç§»ä¿¡æ¯åªåœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å‡º
- è¿ç§»åœ¨åå°é™é»˜å®Œæˆ

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯åº”ç”¨å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ é˜…è¯»å™¨é¡µé¢   â”‚  â”‚  ç”Ÿè¯æœ¬é¡µé¢   â”‚  â”‚   è®¾ç½®é¡µé¢      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                â”‚                    â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           useAppStore (Zustand)                     â”‚    â”‚
â”‚  â”‚   - loadVocabulary()  - addWord()  - saveSettings() â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚ï¼ˆService Layerï¼‰                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ supabaseService â”‚ dataMigrationâ”‚ â”‚ localStorage â”‚      â”‚
â”‚  â”‚ - vocabulary   â”‚  - migrate   â”‚  â”‚ - fallback   â”‚      â”‚
â”‚  â”‚ - progress     â”‚  - autoMigrateâ”‚ â”‚             â”‚      â”‚
â”‚  â”‚ - settings     â”‚              â”‚  â”‚             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase Cloud                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ PostgreSQL DBâ”‚  â”‚  Auth (JWT) â”‚  â”‚ Row Level    â”‚      â”‚
â”‚  â”‚ - user_vocab â”‚  â”‚  - Google   â”‚  â”‚ Security     â”‚      â”‚
â”‚  â”‚ - progress   â”‚  â”‚  OAuth      â”‚  â”‚ (RLS)        â”‚      â”‚
â”‚  â”‚ - settings   â”‚  â”‚             â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åç«¯æ•°æ®åŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EPUBä¹¦ç±å¯¼å…¥æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  import_book.py è„šæœ¬          â”‚
           â”‚  - è§£æEPUB                   â”‚
           â”‚  - æå–ç« èŠ‚å’Œè¯æ±‡              â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  åŒå†™ç­–ç•¥ï¼ˆDual-Writeï¼‰â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                                â”‚
      â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite   â”‚                    â”‚ Supabase   â”‚
â”‚ (æœ¬åœ°)   â”‚                    â”‚ (äº‘ç«¯)     â”‚
â”‚ - ä¸»æ•°æ®æºâ”‚                    â”‚ - åŒæ­¥å‰¯æœ¬ â”‚
â”‚ - å‘åå…¼å®¹â”‚                    â”‚ - ç”¨æˆ·å…±äº« â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  å‰ç«¯å¯è®¿é—®ä¸¤è€…  â”‚
         â”‚  ä¼˜å…ˆä½¿ç”¨Supabase â”‚
         â”‚  å¤±è´¥fallbackåˆ°   â”‚
         â”‚  localStorage     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å®‰å…¨æ€§è®¾è®¡

### Row Level Security (RLS)

**ç”¨æˆ·æ•°æ®è¡¨ï¼ˆuser_vocabulary, reading_progress, user_settingsï¼‰ï¼š**
- âœ… å¯ç”¨RLS
- âœ… ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- âœ… ç­–ç•¥ï¼š`auth.uid() = user_id`

**ä¹¦ç±æ•°æ®è¡¨ï¼ˆbooks, chapters, book_vocabularyï¼‰ï¼š**
- âŒ ä¸å¯ç”¨RLS
- âœ… å…¨å±€å¯è¯»ï¼ˆå…¬å¼€æ•°æ®ï¼‰
- âœ… åªæœ‰åç«¯ï¼ˆService Role Keyï¼‰å¯å†™

### å¯†é’¥ç®¡ç†

**å‰ç«¯ï¼ˆAnon Keyï¼‰ï¼š**
- âœ… æµè§ˆå™¨ä¸­å¯è§
- âœ… å—RLSä¿æŠ¤
- âœ… åªèƒ½è®¿é—®ç¬¦åˆRLSç­–ç•¥çš„æ•°æ®

**åç«¯ï¼ˆService Role Keyï¼‰ï¼š**
- âœ… æœåŠ¡å™¨ç«¯ç§å¯†å­˜å‚¨
- âœ… ç»•è¿‡RLSï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
- âœ… ç”¨äºä¹¦ç±æ•°æ®å¯¼å…¥

---

## ğŸ“Š æ•°æ®è¿ç§»ç»Ÿè®¡

### å·²è¿ç§»æ•°æ®ï¼ˆç¤ºä¾‹ï¼‰
- ğŸ“š **ä¹¦ç±**: 2æœ¬
  - Midnight on the Moon
  - Magic Tree HouseÂ® #17: Tonight on the Titanic
- ğŸ“– **ç« èŠ‚**: 27ä¸ª
- ğŸ“ **é«˜é¢‘è¯æ±‡**: 200ä¸ª

### ç”¨æˆ·æ•°æ®åŒæ­¥
- âœ… è¯æ±‡æœ¬ï¼šè‡ªåŠ¨åŒæ­¥
- âœ… é˜…è¯»è¿›åº¦ï¼šè‡ªåŠ¨åŒæ­¥
- âœ… ä¸ªæ€§åŒ–è®¾ç½®ï¼šè‡ªåŠ¨åŒæ­¥
- âœ… localStorageæ•°æ®ï¼šé¦–æ¬¡ç™»å½•è‡ªåŠ¨è¿ç§»

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### åŠŸèƒ½æµ‹è¯•
- âœ… Google OAuthç™»å½•æµç¨‹
- âœ… ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼ˆå¤´åƒã€é‚®ç®±ã€ä¸‹æ‹‰èœå•ï¼‰
- âœ… é€€å‡ºç™»å½•
- âœ… æ·»åŠ ç”Ÿè¯åˆ°äº‘ç«¯
- âœ… æœªç™»å½•çŠ¶æ€è®¿é—®é™åˆ¶
- âœ… ç”Ÿè¯æ·»åŠ æˆåŠŸåé¦ˆ
- âœ… ä¸Šä¼ é¡µé¢ç™»å½•æ£€æŸ¥
- âœ… æ•°æ®è‡ªåŠ¨è¿ç§»ï¼ˆé™é»˜ï¼‰
- âœ… localStorage fallbackæœºåˆ¶
- âœ… å¤šè®¾å¤‡åŒæ­¥ï¼ˆåŒä¸€è´¦å·ï¼‰

### æ€§èƒ½æµ‹è¯•
- âœ… SupabaseæŸ¥è¯¢é€Ÿåº¦ï¼š<200ms
- âœ… æ‰¹é‡æ’å…¥æ€§èƒ½ï¼š100ç« èŠ‚/ç§’
- âœ… OAuthç™»å½•å“åº”ï¼š<2ç§’

---

## ğŸ“ é…ç½®æ¸…å•

### å‰ç«¯é…ç½®
```env
# frontend/.env.local
VITE_SUPABASE_URL=https://zxbijuzcrjdstgfzukfq.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### åç«¯é…ç½®
```env
# backend/.env
SUPABASE_URL=https://zxbijuzcrjdstgfzukfq.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (Service Role)
```

### Google OAuthé…ç½®
- **Client ID**: `462926893936-...apps.googleusercontent.com`
- **Client Secret**: `GOCSPX-...`
- **æˆæƒæ¥æº**: `http://localhost:5176`
- **å›è°ƒURI**: `https://zxbijuzcrjdstgfzukfq.supabase.co/auth/v1/callback`

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### ä¼˜å…ˆçº§1ï¼šåŠŸèƒ½å®Œå–„
- [ ] å¿˜è®°å¯†ç åŠŸèƒ½
- [ ] é‚®ç®±å¯†ç ç™»å½•ï¼ˆé™¤äº†Google OAuthï¼‰
- [ ] ç”¨æˆ·èµ„æ–™ç¼–è¾‘

### ä¼˜å…ˆçº§2ï¼šæ•°æ®åˆ†æ
- [ ] å­¦ä¹ ç»Ÿè®¡é¢æ¿
  - æ€»å­¦ä¹ æ—¶é•¿
  - å·²è¯»ä¹¦ç±æ•°é‡
  - è¯æ±‡é‡å¢é•¿æ›²çº¿
- [ ] é˜…è¯»æˆå°±ç³»ç»Ÿ

### ä¼˜å…ˆçº§3ï¼šç¤¾äº¤åŠŸèƒ½
- [ ] è¯»ä¹¦ç¬”è®°åˆ†äº«
- [ ] å­¦ä¹ å°ç»„
- [ ] æ’è¡Œæ¦œ

---

## ğŸ› å·²çŸ¥é—®é¢˜

æ— é‡å¤§é—®é¢˜ã€‚

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

1. **åŒå†™ç­–ç•¥**ï¼šSQLite + Supabaseï¼Œä¿è¯å‘åå…¼å®¹
2. **ä¼˜é›…é™çº§**ï¼šSupabaseå¤±è´¥æ—¶è‡ªåŠ¨fallbackåˆ°localStorage
3. **è‡ªåŠ¨è¿ç§»**ï¼šé¦–æ¬¡ç™»å½•é™é»˜è¿ç§»å†å²æ•°æ®
4. **RLSå®‰å…¨**ï¼šç”¨æˆ·æ•°æ®éš”ç¦»ï¼Œé˜²æ­¢è¶Šæƒè®¿é—®
5. **æ‰¹é‡æ“ä½œ**ï¼šé«˜æ•ˆçš„æ‰¹é‡æ’å…¥ï¼ˆç« èŠ‚/è¯æ±‡ï¼‰
6. **UIåé¦ˆ**ï¼šæ·»åŠ ç”Ÿè¯æˆåŠŸåè§†è§‰åé¦ˆï¼ˆç»¿è‰²âœ“ï¼‰
7. **ç™»å½•æ£€æŸ¥**ï¼šå‹å¥½çš„å¼¹çª—æç¤ºï¼Œè€Œéå¼ºåˆ¶è·³è½¬

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Supabase Documentation](https://supabase.com/docs)
- [Google OAuth 2.0](https://developers.google.com/identity/protocols/oauth2)
- [Row Level Security (RLS)](https://supabase.com/docs/guides/auth/row-level-security)
- [React + Supabase Guide](https://supabase.com/docs/guides/getting-started/quickstarts/reactjs)

---

## ğŸ‘¥ å›¢é˜Ÿæˆå‘˜

- **å¼€å‘è€…**: Claude + cherry_xiao
- **æµ‹è¯•**: cherry_xiao

---

## ğŸ“… æ—¶é—´çº¿

- **2025-11-26 09:00** - å¼€å§‹ï¼šåˆ›å»ºSupabaseé¡¹ç›®å’ŒOAuthé…ç½®
- **2025-11-26 11:00** - å®Œæˆå‰ç«¯è®¤è¯å®ç°
- **2025-11-26 13:00** - å®Œæˆå‰ç«¯æ•°æ®åŒæ­¥
- **2025-11-26 15:00** - å®Œæˆåç«¯Supabaseé›†æˆ
- **2025-11-26 16:00** - æ•°æ®è¿ç§»æˆåŠŸ
- **2025-11-26 17:00** - UIä¼˜åŒ–å’Œé”™è¯¯å¤„ç†
- **2025-11-26 18:00** - æµ‹è¯•å®Œæˆï¼ŒåŠŸèƒ½ä¸Šçº¿

---

**æ€»è®¡ç”¨æ—¶ï¼š** çº¦9å°æ—¶
**ä»£ç è¡Œæ•°ï¼š** çº¦2000è¡Œï¼ˆæ–°å¢+ä¿®æ”¹ï¼‰
**æ–‡ä»¶ä¿®æ”¹æ•°ï¼š** 25ä¸ª

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] ç”¨æˆ·å¯ä»¥é€šè¿‡Googleè´¦å·ç™»å½•
- [x] ç™»å½•åæ•°æ®è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
- [x] å¤šè®¾å¤‡æ•°æ®ä¸€è‡´
- [x] æœªç™»å½•ç”¨æˆ·ä»å¯æµè§ˆä¹¦ç±å’Œé˜…è¯»
- [x] æ·»åŠ ç”Ÿè¯æœ‰ç™»å½•æ£€æŸ¥å’ŒæˆåŠŸåé¦ˆ
- [x] ä¸Šä¼ åŠŸèƒ½æœ‰ç™»å½•æ£€æŸ¥
- [x] localStorageæ•°æ®è‡ªåŠ¨è¿ç§»ï¼ˆé™é»˜ï¼‰
- [x] é€€å‡ºç™»å½•åŠŸèƒ½æ­£å¸¸
- [x] ç”¨æˆ·ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

---

**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆå¹¶é€šè¿‡æµ‹è¯•
